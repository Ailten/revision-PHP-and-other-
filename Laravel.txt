
// --- (1 to 3, intro) Laravel (framework PHP) ---

// ref use as tutorial : https://www.youtube.com/watch?v=xSfZwqzs_OM&list=PLjwdMgw5TTLXz1GRhKxSWYyDHwVW-gqrm&index=1
// doc : laravel.com/docs/10.x


// Laravel is a framework, model-vue-controller (use to map DB object on PHP).
// doc : https://laravel.com/docs/11.x

// Laravel 10 need min PHP 8.1
// ask vertion PHP. -> php --version
// ask vertion Composer. -> composer --version


sudo apt update  // udpate.
curl -sS https://getcomposer.org/installer | php  // install Composer from url (and execute by php).
sudo mv composer.phar /usr/local/bin/composer  // move the install Composer in usr folder.
composer create-project laravel/laravel <mon-projet>  // create a new projet With composer.

cd <mon-projet>
sudo chown -R $USER:www-data storage bootstrap/cache  // set permission and who handle the folder.
sudo chmod -R 775 storage bootstrap/cache

php artisan serve --host=0.0.0.0 --port=8000  // launch the server (facultatif).


// a Composer is a gestionair of dependancy for php (like a json file including all vertion and dépendency for a project).
// (I use Composer 2.9.2 , PHP 8.3.6 ,

// Laravel n'est pas installé globalement sur le systeme, c'est un ensemble de fichier php et dépendance.

// -------->

// composer.json  // is the file with dependency of the project.
// bootstrap/app.php  // is the file who launch the application.
// config/mail.php  // use to configure the mailing.
// database/factories  // for connection to DB.
// public  // is the racine path for the app (all heer is publicly accessible).
// ressources  // for CSS, JS, views, etc.
// routes  // the path of the app.
// .env  // parameters of aplication.

// new projet composer include a gitignore but not init the git.
// les fichier CSS et JS son injecté via Blade et Vite.

// set up the DB pasword in .env :
DB_DATABASE="my_db_name"
DB_USERNAME="my_login_db"
DB_PASSWORD="my_password_db"


// --------> execute the web project (preparatoir) :
cp .env.example .env  // config env.
composer install  // (facultatif, for generate vendor folder).
--> (if fail) : composer diagnose  // to diagnose what probleme with composer.
----> (if need clean, many try) : rm -rf vendor composer.lock
---->                             composer clear-cache
--> (can be usefull, laravel need at least all this) : sudo apt install php8.1-mbstring php8.1-xml php8.1-curl php8.1-zip php8.1-bcmath php8.1-mysql php8.1-intl
// verify folder "vendor" is apear at racine.
php artisan key:generate  // generate the private application key. (it be stor in .env as APP_KEY).

// ------> execute the web project (launch) :
php artisan serve  // start Laravel server.
npm run dev  // start Vite (for inject JS/CSS).
sudo service mysql start  // start MySQL. (or : sudo systemctl start mysql).
// open a browser to http://127.0.0.1:8000/  (or the url seted in .env, verify port to).

// --------> cut-down the web project :
php artisan down --message="Le site est en maintenance temporaire"  // cut down the project (and put a message for users).
php artisan queue:restart  // cut down the call to other services.
mysqldump -u root -p <db_name> > backup.sql  // (optionel, backup DB).
--> (clean) : php artisan cache:clear
-->           php artisan config:clear
-->           php artisan route:clear
-->           php artisan view:clear



// ---------------> (4) root :

// in laravel, to define the root (path url of all web page of the project), use routes/web.php to define root.

// example :
Route::get('/', function () {
    return view('welcome');
});
// this bloc say : when the url "/" (default page), return the view "welcome" (you can define a view as a web page).

return to_route('nameRoute', ['id' => 5]);  // this re-direct to another route, with a param id in url.

// views are define in ressources/views/***.php and it's basicly a php-html file.

// you can return a string (for debuging) or an object (example for make end-point API).
// tou can set a parametre \illuminate\Http\Request un the lambda function, to get info about the call (like in a POST/GET call).
// --> for import Requet : use Illuminate\Http\Request;
Route::get('/', function (Request $request) {
// Request object contain other data about the call, like the path :
echo($request->path());
dump($request->path());  // heer, function to debug console.
dd($myVariable);  // die and debug : make processuce crash and print the variable send (type and contend).
// other example.
Route::get('/debug', function (Request $request) {
    return [
        'request_path' => $request->path(),  // word of url (root).
        'request_path' => $request->url(),  // full url.
        'request_path' => $request->all(),  // array of all parameter send (in post or get), example et in url as ".../debug?name=Toto&age=22".
        'request_path' => $request->input('name', 'myPlaceholder'),  // get a specific parameter sended (if not found, return null).
    ];
});

// you can define a route with parameter :
Route::get('/debug/{table}-{id}', function (string $table, string $id, Request $request) {
// and add contrainte on the parameter (at end of block Route::get :
})->where([
    'table' => '[a-zA-Z\-]+',
    'id' => '[0-9]+',
]);

// you can add a name of the root (for bether mainteine of code) :
})->name('debug');  // use a generic name of what it does.

// you can generate a link.
return [
    'link' => \route('debug', ['table' => 'user', 'id' => 12]),  //'debug' is the name of route set by ->name().
];

// you can regroup many root by a prefix :
Route::prefix('/homepage')->group(function() {  // all route declarated in this scrop function have /homepage behind their route.
    Route::get('/debug', function() {  // example : /homepage/debug
        return 'debug';
    });
});
// and you can add a prefix name :

// you can print all route in console server :
php artisan route:list  // print in console all route generate.
Route::prefix('/homepage')->name('homepage.')->group(function() {  // heer, all name route in the scope have homepage. in their name.

// send something (like a message valdiation, to the page destination view).
->with('success', "my succes message");  // take in cash for one redirection only.
@session('success')  // in view to get the message send.

// example of post send process.
Route::get('/my/path/url', 'myFunctionControllerToCallForVerifyTheDataSend')->name('my.name.for.this.root);
Route::post('/my/path/url' 'myFUnctionControllerToCallForConvertDataPostSend');



// ---------------> (5) DB interaction : 

// ORM = Object Relational Maping -> when a project remap all DB table in Obeject (class) to use easily when the code need to interact with DB.

// config/database.php for details of what type of DB is suported (and how).
// .env for the type of DB use, host IP, port, login, password etc.

// (facultatif : for migration of a new DB)
// you can use sqlit (in DB_CONNECTION), delete the other param relate to DB in the block.
// in cmd call : php artisan make:migration [nameOfMigration_like_CreateProductsTable]  // it create a generation file of table in database/migrations/...php
// like :
return new class extends Migration  // class migration (like a block for the table sql).
{
    public function up(): void  // when up (start).
    {
        Schema::create('users', function (Blueprint $table) {  // create the table "users".
            $table->id();   // set a param named "id".
            $table->string('email')->unique();  // param name "email", type string, and unique contraint.
            $table->longText('description');  // param for a long texte (not only one word).
            $table->timestamp('email_verified_at')->nullable();  // param type timeStamp.
            $table->rememberToken();  // use to stay connected.
            $table->timestamps();  // add 2 time stamps, one who edit eatch time the object is update on DB, and one when it create in DB.
            $table->foreignId('user_id')->constrained()->onDelete('cascade');  // add a FK to user 
            // need "constrained()", with param "user" (table target), without param it take the name befor "_id".
            // "onDeletete('cascade')" say "delete this OBJ when the FK is deleted".
        });
    }
    public function down(): void  // when down (shut-down).
    {
        Schema::dropIfExists('users');  // drop the talbe "users".
        Schema::table('orders', function(Blueprint $table){  // when delete an element of this class model : drop the foreign key on this table to.
            $table->dropForeignIdFor(User::class)
        });
    }
}
// in cmd call : php artisant migrate  // for execute and create the ORM of DB.
// --> this cmd generate a file database/seeders/database.sql  // can be use to generate the DB.
// --> this cmd can have "-m" at end for generate model at same time.

// in cmd : php artisan make:model [nameOfTable(singulier)]  // create a model (in app/Models/...php) : class ORM of a table DB.
// --> all ORM class can instaniate ("$user = new Users();"), affected ("$user->email = 'toto';"), and save in DB ("$user->save();").

// you can get all line of a table like this :
User::all();  // return an array of all user in DB.
DB::table('users')  // same as "User::all()".
User::all('id', 'email');  // return an array of object (only id and email) in DB (table user).
User::find(1);  // return the user who has "1" as id. (can return null).
User::findOrFail(1);  // same has find, but crash if not find a match (crash as error web page 404).
User::paginate(10);  // get all row paginated (return an obj LengthAwarePaginator), the obj paginator contain, an array of data of page, current page, last page, url for previous and next page, ... etc.
User::paginate(10, ['id', 'email']);  // define what parameters you whant from objects users.
User::where('id', '>', 0)->first();  // get users where "id > 0" (like where sql), and take the first element of the array return.
User::where('id', '>', 0)->get();  // same but take all elements.
User::where('id', '>', 0)->limit(1)->get();  // use limit like sql.
->orWhere(function(Builder $query){ ... })  // example of OR and sub query.
->whereNot(function(Builder $query){ ... })  // example not (has orWhereNot to).
->groupBy('email')  // group by.
->joinSub(...)  // join.
->union(...)  // union of two query.
->orderByName()  // order by champ "name".
User::has('roles', '>', 1)->get();  // get user who has at least one role (in jointure many to many).
// ---> see laravel.com/docs/10.x/queries  for more example.

// ---> CRUD
$user = User::find(1);  // get from DB.
$user = new User();  // create a new user (not in DB, only in backend).
$user->email = 'new@email.com';  // edit param of object (not in DB, only in backend).
$user->email;  // get param of object.
$user->save();  // insert or update (if it alread exist in DB).
$user->delete();  // delete from DB.

$user = User::create([  // way to create (in DB directly).
   'email' => 'my@email.com' 
]);
// this aproche need to declarate in class ORM :
protected $fillable = ['email'];  // with all parameter name to send.

protected $quarded = ['id'];  // or this way, by sending all param to not send in array.

$user = User::where('id', '=', 1)->update([  // update where (usefull for update many thing sincroniusly), work also with delete.
    'email' => 'my@email.com'
]);

$user->role?->name  // "?" prevent to a parameter nullable (when print in a view : if null print nothing at all).
$user->myCollection->isEmpty()  // verify if a collection is empty.


// ---------------> (6) Controller : 

// class Controller is a class to organise code and logique (regroup methode with the same logic), Controller of data.
// typicly, the Controller took data (raw), and transform it to make it exploitable to the View.
// example manage get articles and pagination for route (the lambda of routing pages).

php artisan make:controller [nameOfMyController_example_UserController]  // create a controller (default).
// file is create in app/Http/Controller/...php

// for use a methode in a controller :
Route::get('/', [MyController::class, 'myMethodeInController'])  // call has an array of 2 elements, the class Controller, and a string of the methode to call.

// you can also define a controller for a whole block :
Route::prefix('/home')->name('home.')->controller(MyController:class)->group(function(){
    Route::get('/', 'myMethodeInController')->name('index');
});

// example of unique except this one (for update).
Rule::unique('talbeNames')->ignore($this->name)
Rule::unique('talbeNames')->ignore($this->route()->parameter('name'))  // same (but more clean, if there no element).



// ---------------> (7) View (with Blade) : 

// a view is a template to print a page for users.
// in ressources/views/[myFolder]/[myNameView].blade.php

// you can use view as part of html code to import in another (like header, footer, menu, ...).
@yield('contains')  // in the block B, to define the part to replace. (use encre named)
@extends('myNameView')  // in the block A, to tel to get the block B.
@section('contains')  // in A, to define the scope of yield in B. (use encre named)
@endsection  // close the scope.
@section('title', 'myTitle')  // you can also define a short text (and many section by page, with distinct encre).
// block A -> @extends, section, endsection  // call A, who take his data and gref into B.
// block B -> @yield  // be called in cascade, and take the data from A.

return view('myFolder.myNameView');  // in Controller (or route), define to load a view at a route.

{{ "my data to print in page" }}  // you can print data string in html view (with this methode, is prevent to html injection.
env('MY_KEY')  // get const env value.

// other fonctionality, doc : laravel.com/docs/10.x/blade
@foreach($users as $user)
@endforeach
@forelse  // like a foreach, bt if the collection is notdefined or empty, execute the block @empty.
@while(true)
@if(true)
@endif
@else
@auth
@endauth
@dump($user)  // debug at screen the contend of variable. (same as dd() but in view).
@php
@endphp
@class(['myClass', 'myConditionClass' => true])  // set class (by an array of string) and can declare condition to set eatch class (like "if (...) class").
@include('')  // include a template.


// in a view, send a pagination obj alow to print the button next/previous page :
{{ $posts->links() }}  // print an html block of button next page and previous page.
// for editing way it print : app/Providers/AppServiceProvider.php
public function boot(): void {
    Paginator::useBootstrapFive();  // to use Boostrap style for pagination.
}

// make a link :
<a href="{{ route('home.user.show', ['id' => $post->id]) }}" class="btn">myLink</a>

request()  // get obj of request to load the view.
request()->route()  // get the route use.
request()->route()->getName()  // get name route (the name, not the url).

// MVC -> Model (object mirroring of table DB), Controller (who get data and place in forme for the print in view), View (the print at screen for user).
// Root to define wich url call what view.
// Service for interact with DB. (~)

Route::getCurrentRoute()->getName()  // get the route name of current page (callable in view).



// ---------------> (8) Validation (Validator) :

// a Validator is a class to validate data (is it respect the regex, all champs constraint for DB... etc).
// doc : laravel.com/docs/10.x/validation

// make a Validator (Illuminate\Support\Facades).
$validator = Validator::make([
    'title' => ''  // user send a title empty, at creating the obj Model.
], [
    'title' => 'required|numeric',  // define parameter title as contraint "required" and "numeric".
    'email' => ['required', 'min:8'],  // same, but can send as an array (mor pratic for many condition, or regex).
    'name' => [Rule::unique('users')],  // same, but with object rule (instead of string), heer unique in table 'users'.
    'abc' => ['regex:/^[a-z]+$/']  // regex example.
    'role_id' => ['exists:roles,id']  // need to exist in table roles (specify what table, and what champ in this table).
]);
// other restiction :
min:8  // restrict length to 8 char min.

$validator->fails()  // return if the validation test is fail (to cancel action).
$validator->errors()  // return an object with all error find in validation (to print at user).
$validator->validated()  // return all champs validated (to get what champs is already good), can throw an error (ValidationException).

php artisan make:request [myRequestName]  // create a file request SQL in app/Http/Requests/...php
// "autorize()"  is for say "is the user has autorisation to acces this request SQL".
// "rules()"  return an array, for rules of validation (generate array for validator heer).
// now, send the class Request in parameter of Controller / route (has extend of FormRequest), instead of $request.
// with a class Request (who verify by rules), it take only champ matching (throw error if one fail a rule, and igniore those not declarated).
// you can add prepareForValidation() methode :
protected function prepareForValidation(){
    $this->merge([
        'newChamp' => 'new champ pushed before validation',
        'abc' => $this->input('abc') ?: 'default value'  // take abc if aleady exist, coales, default value.
    ]);
}

// helpers string (function natif to laravel, usefull), doc : laravel.com/docs/10.x/helpers#strings
// example :
Str::slug('abc d', '-');  // replace space by '-', for generate an url namespace part (~).
Str::slug($this->input('name'));  // take the name champs and "sanitize" (for use has a slug).



// ---------------> (9) Model binding :

// make the Controller work (in rooting), more natively.
// now send an obj Post at param url (it's reduce code for the "findOrFail()".

public function myRoot(Post $post): View {
    return view('myView', [ 'post' => $post ]);  // send the object post to the view.
}

Route::get('/myRoot/{post:myParameter}', 'myRoot')->name('myRoot');



// ---------------> (10) Debuging :

// Debugbar for Laravel, add a debug bar to the browser page executing your laravel project (indicate the state of page, view, ...etc).
// Doc : github.com/barryvdh/laravel-debugbar
// --> composer require barryvdh/laravel-debugbar --dev  // install.

// Ide Helper for Laravel, help to bether auto completion.
// Doc : github.com/barryvdh/laravel-ide-helper
// --> composer require --dev barryvdh/laravel-ide-helper  // install (allow you to use other methode, like :).
// ----> php artisan ide-helper:models  // generate doc based on the DB (it help to autocomplet what "post" it suposed to contains when it's not type).
//                                      // re-execute this cmd when you edit the DB.

// Laravel Idea, (?).



// ---------------> (11) Formulaires (Create, Update) :

// View.
<form action="" methode="post">
    @csrf  <!-- use to generate a token (in session user), for be sure the form came from our web app. -->
    <input type="text" name="name">
    <input type="submit" value="submit">
    <button>submut</button>
</form>

// Roote.
Route::get('/create', 'create')->name('create');
Route::post('/create', 'store');  // store is a ref to a function in Controller.

// Controller (v1).
public function store(Request $request){
    $post = Post::create([  // create an object Post based on the request send (form contend submited), for the page who get the file.
        'name' => $request->input('name'),
        ... // other parameters.
    ]);
    return redirect()->route('/home', [ 'name' => $post->name ])  // redirect to another page.
    ->with('success', "my succes message");  // send a message (param key-value for the view).
}

// View redirected (after form).
<div>
    @if(session('success'))
        <h1>{{ session('success') }}</h1>  <!-- print the message success send (key-value). -->
    @endif
</div>

// MiddleWareGroup :
// in app/Http/Requests/Kernel.php
// list of process execute during a call roote (like when post to a page).
// use for like encrypt cookies.

// build a file for validation of data (send from a form).
php artisan make:request [CreatePostRequest]  // create a file in app/Http/Requests/CreatePostRequest.php.
authorize(): bool { return true; }  // autorized.
public function rules(): array {
    return [
        'name' => 'required|min:3'
    ];
}
protected function prepareForValidation(){
    $this->merge([
        'name' => $this->input('name') ?: "anon"
    ]);
}

// Conroller (v2) : now took the object from controller.
public function store(CreatePostRequest $request){
    $post = Post::create($request->validated());  // now get the validated object data from Controller.
    return redirect()->route('/home', [ 'name' => $post->name ])
    ->with('success', "my succes message");
}

// View (v2) : now print when error find.
@error("name")  <!-- show error (if there one), on what champ. -->
    {{ $message }}
@enderror
<input type="text" value="{{ old('name', $post->name) }}">  <!-- took the old value champ (from last try submit). -->

// regroup form create and update has the same form (for the obj maping).
@if($post->id)
    update title  <!-- in the same form, edit view title or submit, based on if the post has an id. -->
@else
    create title
@endif

// for create view (to merge with the update view), think about send the obejct create (in Controller create function), for prevent error $post is undefined).
public function create(){
    $post = new Post();  // create an empty post.
    $post->name = "name test";  // (facultatif) you can set default seting, or test like this (to the create page).
    return view('create', [
        'post' => $post  // send to the view.
    ]);
}

// (facultatif), you can tsheet on the methode used to send data : (use "PATCH" instead of "POST" for editing).
@method("PATCH")  <!-- in view, it's add a champ for specify wath true type of methode to use. -->



// ---------------> (12) Relation (entre les class model) :

// Doc : laravel.com/docs/10.x/eloquent-relationships#main-content

// in class ORM Role.
// add FK in other ORM class.
public function up(): void {
    Schema::table('users', function(Blueprint $table){
        $table->foreignIdFor(Role)->nullable()->constrained()->cascadeOnDelete()
    });
}

// delete on cascade.
public function down(): void {
    Schema::dropIfExists('categories');
    Schema::table('users', function(Blueprint $table){  // heer.
        $table->dropForeignIdFor(Role::class)
    });
}

// in model class user.
public function role () {  // make a function in model user to return the object role.
    return $this->belongsTo(Role::class);
}

// (oposite) in model class role.
public function users() {
    return $this->hasMany(User::class);
}

// for get objets (from DB) with object in FK :
User::with('role')->get();

// for get by relation, and make a filter on the relation :
$role->users()->where('id', '>', 10)->get();

// edit the role in an user object :
$user->rule()->associate($rule);  // same as change the id fk champ (but by treating with object only).

// example for jointure table :
Schema::create('user_role', function(Blueprint $table){
    $table->foreignIdFor(User::class)->constrained()->cascadeOnDelete();
    $table->foreignIdFor(Role::class)->constrained()->cascadeOnDelete();
    $table->primary(['user_id', 'role_id']);
});

// in user (to get all roles from class many to many) :
public function roles() {
    return $this->belongsToMany(roles::class);
}

// you can use it to create roles : (this creat the relation many to many and create 2 role).
$user->roles()->createMany([ "name"=>"my role 1" ], [ "name"=>"my role 2" ]);

// delete a jointure :
$user->roles()->detach(2);  // delete the relation many to many between this user and the role id "2".
$user->roles()->attach(2);  // add a jointure between the user and role id 2.
$user->roles()->sync([2, 3]);  // delete or add for match to the array role id set.

User::has('roles', '>', 1)->get();  // get user who has at least one role (in jointure many to many).

// get role to send for a form update (for make a foreach in a select), in one to many:
return view('user.update', [
    'post => $post,
    'roles' => Role::select('id', 'name')->get()
]);

<select>
    @foreach($roles as $role)
        <option value="{{ $role->id }}" @selected(old('role_id', $user->role_id) == $role->id)>{{ $role->name }}</option>
    @endforeach
</select>

<input type="checkbox" @checked(old('isVip', $user->isVip)) />  <!-- same for input checkbox -->

// same for many to many :
@php
$rolesIdsInUser = $user->roles()->pluck('id');  // take only the id of jointure user-role (in a collection).
@endphp
<select multiple name="roles[]">  <!-- name as an array -->
    @foreach($roles as $role)
        <option value="{{ $role->id }}" @selected($rpmesIdsInUser->contains($role->id))>{{ $role->name }}</option>
    @endforeach
</select>



// ---------------> (-) inject/import JS, CSS, avec Vite :

// sudo apt install npm  // need npm, so download if not already on the machine.
// --> npm install  // in folder project, to install dependances JS.
// --> npm run dev  // launch Vite (on dev mode), it need NodeJS v 18 or +, it launch Vite.
// ----> npm run build  // if in production use build instead of dev.

// place file JS and CSS in ressources/[css|js]/ (instead of public/[css|js]/).
// create a view layout.blade.php :
// --> @vite(['resources/js/app.js', 'resources/css/app.css'])
// inject from other view with :
// --> @extends('myFolder.layout')

// adding bootstrap :
// --> npm install bootstrap  // in cmd folder project.
// in js file :
// import 'bootstrap';
// in css file :
// @import "bootstrap/dist/css/bootstrap.min.css";



// ---------------> (13) Authentification :






// esque je peu utiliser un certifica SSL si mon site n'a pas de nom de domaine ?
// comment executer "artisant server" et "npm start dev" en une foi, en ayant le résultat temps réel des 2 dans la meme console ?




// TODO: continue tuto : 
// https://www.youtube.com/watch?v=xHrHjj8eFk0&list=PLjwdMgw5TTLXz1GRhKxSWYyDHwVW-gqrm&index=13





// examples :
str_replace('_', '-', app()->getLocale())
url('/home')
Route::has('login')




// example of controller class.
class UserController
{
    public function index()
    {
        $users = User::active()
            ->orderByName()
            ->get(['id', 'name', 'email']);

        return Inertia::render('Users', [  // Inertia::render (??)
            'users' => $users,
        ]);
    }
}

// example to render an entity in html.
export default ({ users }) => {
    return (
        <div>
            <h1>Users</h1>
            <ul>
                {users.map((user) => (
                    <li key={user.id}>{user.name}</li>
                ))}
            </ul>
        </div>
    );
};

